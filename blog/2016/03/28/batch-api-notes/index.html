
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Batch API Notes - J2hongming Blog</title>
  <meta name="author" content="HongMing ChangChine">

  
  <meta name="description" content="設定operations
設定batch資訊
設定finish callback function
線上展示
其他批次處理可用模組 Batch sets are used to spread processing (primarily, but not exclusively, forms &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://j2hongming.github.io/blog/2016/03/28/batch-api-notes">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="J2hongming Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-55818738-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">J2hongming Blog</a></h1>
  
    <h2>Notes for Reusing.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:j2hongming.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/toolbox">ToolBox</a></li>  
  <li><a href="/bookshelf">BookShelf</a></li>
  <li><a href="https://www.linkedin.com/in/j2hongming">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Batch API Notes</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-03-28T14:41:34+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>2:41 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://j2hongming.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><ul>
<li>設定operations</li>
<li>設定batch資訊</li>
<li>設定finish callback function</li>
<li>線上展示</li>
<li>其他批次處理可用模組</li>
</ul>


<!-- more -->


<blockquote><p>Batch sets are used to spread processing (primarily, but not exclusively, forms processing) over several page requests. This helps to ensure that the processing is not interrupted due to PHP timeouts, while users are still able to receive feedback on the progress of the ongoing operations.
<a href="https://api.drupal.org/api/drupal/includes%21form.inc/group/batch/7">Batch operations</a></p></blockquote>

<h2>設定operations</h2>

<p>可依照需求切割一個operation內做的事，假設1000個node，可以一個operation處理一個node或一個operation處理多個node。Client端利用ajax對<a href="https://sitename/batch?id=">https://sitename/batch?id=</a>[batch_id]&amp;op=do發出HttpRequest。</p>

<pre><code>// 假設$data是從EXCEL中讀出的資料

$split_rows = array_chunk($data, 50);

foreach ($split_rows as $key =&gt; $rows) {
  $operations[] = array(
    'import_batch_processing',  // The function to run on 50 row in one operation
    array($rows),  // The rows in the Excel
  );
}
</code></pre>

<h2>設定batch資訊</h2>

<pre><code>$batch = array(
  'title' =&gt; t('批次處理中...'),
  'operations' =&gt; $operations,  // Runs all of the queued processes from the while loop above.
  'file' =&gt; drupal_get_path('module', 'module_name_which_you_create') . '/import_batch_processing.inc',
  'finished' =&gt; 'import_batch_processing_finished', // Function to run when the import is successful
'error_message' =&gt; t('The installation has encountered an error.'),
'progress_message' =&gt; t('資料匯入中...'),
);
</code></pre>

<ul>
<li><code>file</code>: 若import_batch_processing和import_batch_processing_finished沒有定義在.module檔內，需設定有定義這兩個callback function的file。<a href="http://data.agaric.com/batch-api-process-silently-fails-if-function-file-not-default-drupal-bootstrap-isnt-explicitly-inclu">Batch API process silently fails</a></li>
<li><code>finished</code>: batch結束後須執行的callback function</li>
<li><code>error_message</code>:batch過程中若發生錯誤的回傳訊息</li>
<li><code>progress_message</code>: batch過程中顯示的訊息</li>
</ul>


<h2>設定finish callback function</h2>

<pre><code>function import_batch_processing_finished( $success, $results, $operations ){
if($success){
  ...
}
else {
  // An error occurred.
  // $operations contains the operations that remained unprocessed.
  $error_operation = reset($operations);
  drupal_set_message(
    t('An error occurred while processing @operation with arguments : @args',
      array(
        '@operation' =&gt; $error_operation[0],
        '@args' =&gt; print_r($error_operation[0], TRUE),
      )
    )
  );
}
</code></pre>

<h2>線上展示</h2>

<ol>
<li><a href="https://simplytest.me/">Evaluate Drupal projects online</a></li>
<li>安裝模組 Examples for Developers</li>
<li>登入admin帳號後，開啟模組Devel generate和Batch example</li>
<li>前往路徑 admin/config/development/generate/content，新增1000個測試Node</li>
<li>前往路徑 examples/batch_example，開始測試</li>
</ol>


<blockquote><p>可配合程式碼觀察
<a href="http://cgit.drupalcode.org/examples/tree/batch_example/batch_example.module?id=refs/heads;id2=7.x-1.x">Batch example source code</a></p></blockquote>

<h2>其他批次處理可用模組</h2>

<ul>
<li><a href="https://www.drupal.org/project/views_data_export">Views Data Export</a></li>
<li><a href="https://www.drupal.org/project/node_export">Node export</a></li>
</ul>


<h2>Ref.</h2>

<ul>
<li><a href="https://api.drupal.org/api/drupal/includes%21form.inc/group/batch/7">Batch operations</a></li>
<li><a href="https://www.drupal.org/node/180528">how to use the Batch API</a></li>
<li><a href="http://www.jeffgeerling.com/blogs/jeff-geerling/using-batch-api-build-huge-csv">Using Batch API to build huge CSV files for custom exports</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">HongMing ChangChine</span></span>

      




<time class='entry-date' datetime='2016-03-28T14:41:34+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>2:41 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/batch/'>batch</a>, <a class='category' href='/blog/categories/drupal7/'>drupal7</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://j2hongming.github.io/blog/2016/03/28/batch-api-notes/" data-via="" data-counturl="http://j2hongming.github.io/blog/2016/03/28/batch-api-notes/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/03/28/how-to-access-data-in-drupal-7/" title="Previous Post: How to access data in Drupal 7">&laquo; How to access data in Drupal 7</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/03/31/drupal-development-resources/" title="Next Post: Drupal Development Resources">Drupal Development Resources &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/08/10/java-string-basic/">Java String 常用操作</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/04/gitbook-outline-number/">如何設定gitbook側邊欄大綱顯示階層數字</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/02/thoughts-about-courses-in-computer-science/">資工系課程整理與心得</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/28/windows-batch-file-notes/">Windows Batch File Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/20/relational-database-notes/">關聯式資料庫筆記</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - HongMing ChangChine -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'j2hongminggithubio';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://j2hongming.github.io/blog/2016/03/28/batch-api-notes/';
        var disqus_url = 'http://j2hongming.github.io/blog/2016/03/28/batch-api-notes/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
