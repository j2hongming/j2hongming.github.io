<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Batch API Notes | I'm J2hongming</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">I'm J2hongming</a><span class="subtitle">Appreciate, respect and accept it, don't take it for granted</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a><a href="/sitemap" class="sidebar-nav-item">SiteMap</a><a href="/experience" class="sidebar-nav-item">Experience</a><a href="/bookshelf" class="sidebar-nav-item">Bookshelf</a><a href="https://www.linkedin.com/in/j2hongming/" class="sidebar-nav-item">About</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Batch API Notes</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-03-28</div><div class="post-categories"><a class="post-category-link" href="/categories/drupal7/">drupal7</a>><a class="post-category-link" href="/categories/drupal7/batch/">batch</a></div></div></div><article><div class="container post"><ul>
<li>設定operations</li>
<li>設定batch資訊</li>
<li>設定finish callback function</li>
<li>線上展示</li>
<li>其他批次處理可用模組</li>
</ul>
<a id="more"></a>

<blockquote>
<p>Batch sets are used to spread processing (primarily, but not exclusively, forms processing) over several page requests. This helps to ensure that the processing is not interrupted due to PHP timeouts, while users are still able to receive feedback on the progress of the ongoing operations.<br><a href="https://api.drupal.org/api/drupal/includes%21form.inc/group/batch/7" target="_blank" rel="noopener">Batch operations</a></p>
</blockquote>
<h2 id="設定operations"><a href="#設定operations" class="headerlink" title="設定operations"></a>設定operations</h2><p>可依照需求切割一個operation內做的事，假設1000個node，可以一個operation處理一個node或一個operation處理多個node。Client端利用ajax對<a href="https://sitename/batch?id=[batch_id]&amp;op=do發出HttpRequest。" target="_blank" rel="noopener">https://sitename/batch?id=[batch_id]&amp;op=do發出HttpRequest。</a></p>
<pre><code>// 假設$data是從EXCEL中讀出的資料

$split_rows = array_chunk($data, 50);

foreach ($split_rows as $key =&gt; $rows) {
  $operations[] = array(
      &apos;import_batch_processing&apos;,  // The function to run on 50 row in one operation
      array($rows),  // The rows in the Excel
  );
}</code></pre><h2 id="設定batch資訊"><a href="#設定batch資訊" class="headerlink" title="設定batch資訊"></a>設定batch資訊</h2><pre><code>$batch = array(
  &apos;title&apos; =&gt; t(&apos;批次處理中...&apos;),
  &apos;operations&apos; =&gt; $operations,  // Runs all of the queued processes from the while loop above.
  &apos;file&apos; =&gt; drupal_get_path(&apos;module&apos;, &apos;module_name_which_you_create&apos;) . &apos;/import_batch_processing.inc&apos;,
  &apos;finished&apos; =&gt; &apos;import_batch_processing_finished&apos;, // Function to run when the import is successful
&apos;error_message&apos; =&gt; t(&apos;The installation has encountered an error.&apos;),
&apos;progress_message&apos; =&gt; t(&apos;資料匯入中...&apos;),
);</code></pre><ul>
<li><code>file</code>: 若import_batch_processing和import_batch_processing_finished沒有定義在.module檔內，需設定有定義這兩個callback function的file。<a href="http://data.agaric.com/batch-api-process-silently-fails-if-function-file-not-default-drupal-bootstrap-isnt-explicitly-inclu" target="_blank" rel="noopener">Batch API process silently fails</a></li>
<li><code>finished</code>: batch結束後須執行的callback function</li>
<li><code>error_message</code>:batch過程中若發生錯誤的回傳訊息</li>
<li><code>progress_message</code>: batch過程中顯示的訊息</li>
</ul>
<h2 id="設定finish-callback-function"><a href="#設定finish-callback-function" class="headerlink" title="設定finish callback function"></a>設定finish callback function</h2><pre><code>function import_batch_processing_finished( $success, $results, $operations ){
if($success){
  ...
}
else {
  // An error occurred.
  // $operations contains the operations that remained unprocessed.
  $error_operation = reset($operations);
  drupal_set_message(
    t(&apos;An error occurred while processing @operation with arguments : @args&apos;,
      array(
        &apos;@operation&apos; =&gt; $error_operation[0],
        &apos;@args&apos; =&gt; print_r($error_operation[0], TRUE),
      )
    )
  );
}</code></pre><h2 id="線上展示"><a href="#線上展示" class="headerlink" title="線上展示"></a>線上展示</h2><ol>
<li><a href="https://simplytest.me/" target="_blank" rel="noopener">Evaluate Drupal projects online</a></li>
<li>安裝模組 Examples for Developers</li>
<li>登入admin帳號後，開啟模組Devel generate和Batch example</li>
<li>前往路徑 admin/config/development/generate/content，新增1000個測試Node</li>
<li>前往路徑 examples/batch_example，開始測試</li>
</ol>
<blockquote>
<p>可配合程式碼觀察<br><a href="http://cgit.drupalcode.org/examples/tree/batch_example/batch_example.module?id=refs/heads;id2=7.x-1.x" target="_blank" rel="noopener">Batch example source code</a></p>
</blockquote>
<h2 id="其他批次處理可用模組"><a href="#其他批次處理可用模組" class="headerlink" title="其他批次處理可用模組"></a>其他批次處理可用模組</h2><ul>
<li><a href="https://www.drupal.org/project/views_data_export" target="_blank" rel="noopener">Views Data Export</a></li>
<li><a href="https://www.drupal.org/project/node_export" target="_blank" rel="noopener">Node export</a></li>
</ul>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref."></a>Ref.</h2><ul>
<li><a href="https://api.drupal.org/api/drupal/includes%21form.inc/group/batch/7" target="_blank" rel="noopener">Batch operations</a></li>
<li><a href="https://www.drupal.org/node/180528" target="_blank" rel="noopener">how to use the Batch API</a></li>
<li><a href="http://www.jeffgeerling.com/blogs/jeff-geerling/using-batch-api-build-huge-csv" target="_blank" rel="noopener">Using Batch API to build huge CSV files for custom exports</a></li>
</ul>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'j2hongminggithubio';
var disqus_identifier = '2016/03/28/batch-api-notes/';
var disqus_title = 'Batch API Notes';
var disqus_url = 'http://yoursite.com/2016/03/28/batch-api-notes/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="http://twitter.com/j2hongming" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/j2hongming" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2020 <a href="/" rel="nofollow">J2hongming</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-55818738-1');ga('send','pageview');</script></html>